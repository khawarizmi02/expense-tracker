# ðŸš€ n8n Integration Setup Guide

This guide will help you set up n8n as a REST API backend for your expense tracker, integrated with Notion databases.

## ðŸ“‹ Prerequisites

- âœ… n8n running at http://localhost:5678
- âœ… Notion account with 4 databases created
- âœ… Docker installed (for running n8n)

## ðŸ—‚ï¸ Your Notion Database IDs

- **Month Classifications**: `2fec5833-e376-81e9-8535-c60e08dd3cf5`
- **Budgets**: `2fec5833-e376-8113-966d-f45b4d963d6a`
- **Expenses**: `2fec5833-e376-8170-9aec-e3a05ffa7138`
- **Incomes**: `2fec5833-e376-8136-94b9-fadf940d20c3`

---

## Part 1: Notion Database Schema Setup

### 1.1 Month Classifications Database

Create a Notion database with these properties:

| Property Name | Type | Description |
|--------------|------|-------------|
| `Name` | Title | Will store the month name (e.g., "December 2026") |
| `month` | Text | Month display name |
| `monthNum` | Text | Format: "mm-yy" (e.g., "01-26") |
| `id` | Text | Unique ID (generated by frontend) |
| `createdAt` | Date | Creation timestamp |

### 1.2 Budgets Database

| Property Name | Type | Description |
|--------------|------|-------------|
| `Name` | Title | Budget category name |
| `category` | Text | Budget category |
| `monthlyBudget` | Number | Budget amount |
| `categoryType` | Select | Options: "Wants", "Needs", "Savings" |
| `id` | Text | Unique ID |
| `createdAt` | Date | Creation timestamp |

### 1.3 Expenses Database

| Property Name | Type | Description |
|--------------|------|-------------|
| `Name` | Title | Expense name |
| `expense` | Text | Expense description |
| `amount` | Number | Expense amount |
| `date` | Date | Expense date |
| `budgetId` | Text | Reference to Budget ID |
| `monthClassificationId` | Text | Reference to Month ID |
| `id` | Text | Unique ID |
| `createdAt` | Date | Creation timestamp |

### 1.4 Incomes Database

| Property Name | Type | Description |
|--------------|------|-------------|
| `Name` | Title | Income name |
| `income` | Text | Income description |
| `amount` | Number | Income amount |
| `date` | Date | Income date |
| `monthClassificationId` | Text | Reference to Month ID |
| `type` | Select | Options: "Salary", "Refund", "Other" |
| `id` | Text | Unique ID |
| `createdAt` | Date | Creation timestamp |

---

## Part 2: Setup Notion Integration in n8n

### 2.1 Create Notion Integration

1. Go to https://www.notion.so/my-integrations
2. Click **"+ New integration"**
3. Fill in details:
   - **Name**: `Expense Tracker Integration`
   - **Associated workspace**: Select your workspace
   - **Type**: Internal integration
4. Click **"Submit"**
5. **Copy the "Internal Integration Token"** (starts with `secret_...`)
   - âš ï¸ **SAVE THIS TOKEN** - You'll need it in the next step!

### 2.2 Share Databases with Integration

For **each** of your 4 Notion databases:

1. Open the database in Notion
2. Click the **"â€¢â€¢â€¢"** menu (top right)
3. Select **"Connections"** â†’ **"Connect to"**
4. Find and select **"Expense Tracker Integration"**
5. Confirm access

### 2.3 Add Notion Credentials to n8n

1. Open n8n: http://localhost:5678
2. Go to **Settings** (bottom left) â†’ **Credentials**
3. Click **"+ Add Credential"**
4. Search for and select **"Notion API"**
5. Fill in:
   - **Credential Name**: `Notion API`
   - **API Key**: Paste your integration token from step 2.1
6. Click **"Save"**

---

## Part 3: Create n8n Workflows

You'll create **4 workflows**, one for each entity. I'll show you detailed steps for the first one, then you can replicate for the others.

### 3.1 Workflow 1: Month Classifications API

#### Step 1: Create New Workflow

1. In n8n, click **"+ Add workflow"** (top right)
2. Name it: **"Expense Tracker - Month Classifications API"**

#### Step 2: Add Webhook Node (Entry Point)

1. Click **"+"** to add a node
2. Search for **"Webhook"**
3. Configure:
   - **HTTP Method**: `GET` (we'll handle all methods dynamically)
   - **Path**: `month-classifications`
   - **Authentication**: `Header Auth`
   - **Header Name**: `X-API-Key`
   - **Header Value**: Choose a secure API key (e.g., `exp-track-secret-2026`)
     - âš ï¸ **SAVE THIS KEY** - Update your `.env.local` file with it!
4. Click **"Execute Node"** to get the webhook URL
5. **Copy the webhook URL** (will be like `http://localhost:5678/webhook/...`)

#### Step 3: Add Switch Node (Route by HTTP Method)

1. Add a **"Switch"** node
2. Configure 4 routes:
   - **Rule 1**: `{{ $('Webhook').item.json.method }}` equals `GET`
   - **Rule 2**: `{{ $('Webhook').item.json.method }}` equals `POST`
   - **Rule 3**: `{{ $('Webhook').item.json.method }}` equals `PATCH`
   - **Rule 4**: `{{ $('Webhook').item.json.method }}` equals `DELETE`

#### Step 4a: GET - Fetch All from Notion

1. Connect **Switch â†’ Output 1** to a new **"Notion"** node
2. Name it: **"Get All Month Classifications"**
3. Configure:
   - **Credential**: Select "Notion API" (created earlier)
   - **Resource**: `Database Page`
   - **Operation**: `Get Many`
   - **Database**: Paste your Month Classifications database ID
     - Remove dashes: `2fec5833e37681e98535c60e08dd3cf5`
4. Add a **"Code"** node after Notion to format response:
   ```javascript
   const items = $input.all();
   const formatted = items.map(item => ({
     id: item.json.properties.id.rich_text[0]?.plain_text || '',
     month: item.json.properties.month.rich_text[0]?.plain_text || '',
     monthNum: item.json.properties.monthNum.rich_text[0]?.plain_text || '',
     createdAt: item.json.properties.createdAt.date?.start || new Date().toISOString()
   }));
   return [{ json: formatted }];
   ```

#### Step 4b: POST - Create New in Notion

1. Connect **Switch â†’ Output 2** to a new **"Notion"** node
2. Name it: **"Create Month Classification"**
3. Configure:
   - **Resource**: `Database Page`
   - **Operation**: `Create`
   - **Database ID**: `2fec5833e37681e98535c60e08dd3cf5`
   - **Title**: `={{ $('Webhook').item.json.body.month }}`
   - **Properties**:
     - Click **"Add Property"** for each:
       - `id` â†’ Text â†’ `={{ $('Webhook').item.json.body.id }}`
       - `month` â†’ Text â†’ `={{ $('Webhook').item.json.body.month }}`
       - `monthNum` â†’ Text â†’ `={{ $('Webhook').item.json.body.monthNum }}`
       - `createdAt` â†’ Date â†’ `={{ $('Webhook').item.json.body.createdAt }}`

#### Step 4c: PATCH - Update in Notion

1. Connect **Switch â†’ Output 3** to a new **"Notion"** node
2. Name it: **"Update Month Classification"**
3. Configure:
   - **Resource**: `Database Page`
   - **Operation**: `Update`
   - **Page ID**: `={{ $('Webhook').item.json.params.id }}` (from URL path)
   - **Properties**: Same as POST, but use:
     - `={{ $('Webhook').item.json.body.month || '' }}`
     - Check **"Only set fields that are not empty"**

#### Step 4d: DELETE - Archive in Notion

1. Connect **Switch â†’ Output 4** to a new **"Notion"** node
2. Name it: **"Delete Month Classification"**
3. Configure:
   - **Resource**: `Page`
   - **Operation**: `Archive`
   - **Page ID**: `={{ $('Webhook').item.json.params.id }}`

#### Step 5: Add Response Nodes

1. Add **"Respond to Webhook"** nodes after each Notion node
2. Configure:
   - **Respond With**: `JSON`
   - **Response Body**: `={{ $json }}`
   - For DELETE: `={{ { "success": true } }}`

#### Step 6: Save & Activate

1. Click **"Save"** (top right)
2. Toggle **"Active"** (top right)
3. **Copy the full webhook URL** - you'll need it!

---

### 3.2 Workflow 2: Budgets API

Repeat the exact same steps as 3.1, but:
- Workflow name: **"Expense Tracker - Budgets API"**
- Webhook path: `budgets`
- Notion Database ID: `2fec5833e376811 3966df45b4d963d6a`
- Properties to map:
  - `id`, `category`, `monthlyBudget` (number), `categoryType` (select), `createdAt`

---

### 3.3 Workflow 3: Expenses API

- Workflow name: **"Expense Tracker - Expenses API"**
- Webhook path: `expenses`
- Notion Database ID: `2fec5833e3768170 9aece3a05ffa7138`
- Properties:
  - `id`, `expense`, `amount` (number), `date` (date), `budgetId`, `monthClassificationId`, `createdAt`

**Additional for GET**: Add filter support for query parameters:
```javascript
// In the Notion node, add filters
const query = $('Webhook').item.json.query;
if (query.monthClassificationId) {
  // Add filter: monthClassificationId equals query.monthClassificationId
}
if (query.budgetId) {
  // Add filter: budgetId equals query.budgetId
}
```

---

### 3.4 Workflow 4: Incomes API

- Workflow name: **"Expense Tracker - Incomes API"**
- Webhook path: `incomes`
- Notion Database ID: `2fec5833e3768136 94b9fadf940d20c3`
- Properties:
  - `id`, `income`, `amount` (number), `date` (date), `monthClassificationId`, `type` (select), `createdAt`

**Additional for GET**: Add filter for `type` query parameter.

---

## Part 4: Frontend Configuration

### 4.1 Update Environment Variables

1. Copy the example file:
   ```bash
   cp .env.example .env.local
   ```

2. Edit `.env.local`:
   ```env
   VITE_N8N_BASE_URL=http://localhost:5678
   VITE_API_KEY=exp-track-secret-2026
   VITE_STORAGE_MODE=localStorage
   ```

3. When ready to test with n8n, change:
   ```env
   VITE_STORAGE_MODE=api
   ```

### 4.2 Test the Integration

1. Restart your dev server:
   ```bash
   bun run dev
   ```

2. Open the app and try creating a month classification
3. Check your Notion database - the entry should appear!

---

## Part 5: Troubleshooting

### Common Issues

#### 1. **401 Unauthorized Error**
- âœ… Verify API key in `.env.local` matches webhook configuration
- âœ… Check `X-API-Key` header is being sent

#### 2. **CORS Error**
- âœ… In n8n workflow settings, enable:
  - **Settings** â†’ **Error Workflow** â†’ Set to continue on error
- âœ… Check webhook node has **"CORS"** option enabled

#### 3. **Notion API Errors**
- âœ… Verify database IDs (remove dashes when using in n8n)
- âœ… Confirm integration has access to databases
- âœ… Check property names match exactly (case-sensitive)

#### 4. **Data Not Appearing**
- âœ… Check n8n execution logs (click workflow â†’ "Executions" tab)
- âœ… Verify Notion property types match (Text, Number, Date, Select)
- âœ… Use browser DevTools â†’ Network tab to see request/response

### Testing Individual Workflows

Use `curl` to test endpoints:

```bash
# Test GET all month classifications
curl -H "X-API-Key: exp-track-secret-2026" \
  http://localhost:5678/webhook/month-classifications

# Test POST create
curl -X POST \
  -H "Content-Type: application/json" \
  -H "X-API-Key: exp-track-secret-2026" \
  -d '{"id":"test-123","month":"January 2026","monthNum":"01-26","createdAt":"2026-01-01T00:00:00Z"}' \
  http://localhost:5678/webhook/month-classifications
```

---

## Part 6: Production Deployment (VPS)

See `NGINX-PRODUCTION-SETUP.md` for detailed production deployment instructions.

---

## ðŸ“š Next Steps

1. âœ… Complete all 4 workflows
2. âœ… Test each endpoint with `curl` or Postman
3. âœ… Switch frontend to API mode
4. âœ… Verify data syncs between web app â†” n8n â†” Notion
5. ðŸš€ Deploy to production VPS

---

## ðŸ†˜ Need Help?

If you encounter issues:
1. Check n8n execution logs
2. Enable browser DevTools â†’ Console
3. Verify Notion integration permissions
4. Test webhooks individually with `curl`

Good luck! ðŸŽ‰
